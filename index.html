<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/liff.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #00B900, #00D924);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            z-index: 1;
            position: relative;
        }
        
        .user-info {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .user-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .user-details h3 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .user-id {
            color: #666;
            font-size: 12px;
        }
        
        .points-section {
            padding: 30px 20px;
            text-align: center;
        }
        
        .current-points {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.3);
        }
        
        .points-label {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .points-value {
            font-size: 36px;
            font-weight: bold;
            color: #e17055;
            margin-bottom: 5px;
        }
        
        .points-unit {
            color: #666;
            font-size: 14px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-add {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: white;
        }
        
        .btn-redeem {
            background: linear-gradient(45deg, #e84393, #d63031);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #00B900;
        }
        
        .hidden {
            display: none;
        }
        
        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .history-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-details {
            flex: 1;
        }
        
        .history-type {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-type.add {
            color: #00b894;
        }
        
        .history-type.redeem {
            color: #e84393;
        }
        
        .history-date {
            color: #666;
            font-size: 12px;
        }
        
        .history-points {
            font-size: 18px;
            font-weight: bold;
        }
        
        .history-points.add {
            color: #00b894;
        }
        
        .history-points.redeem {
            color: #e84393;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #666; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #666, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #666, .5em 0 0 #666; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</h1>
            <p>‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
        </div>
        
        <div class="user-info">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <div class="user-details">
                    <h3 id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
                    <div class="user-id" id="userId">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="points-section">
            <div class="current-points">
                <div class="points-label">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div class="points-value" id="currentPoints">0</div>
                <div class="points-unit">‡πÅ‡∏ï‡πâ‡∏°</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-add" onclick="showAddPoints()">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°
                </button>
                <button class="btn btn-redeem" onclick="showRedeemPoints()">
                    üéÅ ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°
                </button>
            </div>
            
            <div id="addPointsForm" class="hidden">
                <div class="input-group">
                    <label for="addAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°:</label>
                    <input type="number" id="addAmount" min="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°">
                </div>
                <div class="input-group">
                    <label for="addReason">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</label>
                    <input type="text" id="addReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©">
                </div>
                <button class="btn btn-add" onclick="addPoints()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°</button>
                <button class="btn" onclick="hideAddPoints()" style="background: #ddd; color: #666;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            
            <div id="redeemPointsForm" class="hidden">
                <div class="input-group">
                    <label for="redeemAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ:</label>
                    <input type="number" id="redeemAmount" min="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°">
                </div>
                <div class="input-group">
                    <label for="redeemReason">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å:</label>
                    <input type="text" id="redeemReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 10%, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ü‡∏£‡∏µ">
                </div>
                <button class="btn btn-redeem" onclick="redeemPoints()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</button>
                <button class="btn" onclick="hideRedeemPoints()" style="background: #ddd; color: #666;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
        
        <div class="history-section">
            <h3 class="history-title">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</h3>
            <div id="historyList">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const LIFF_ID = '2007712584-v1WRnB24'; // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2lxT5wOjrfFce7QkftQLVhiYfhwE49pXhunpuCAwW3NZbBo8bd_7AVZilVhTk21_lPA/exec'; // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script
        
        let userProfile = null;
        let currentPoints = 0;
        
        // Initialize LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    await getUserProfile();
                    await loadUserPoints();
                    await loadHistory();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                // For testing without LIFF
                loadDemoData();
            }
        }
        
        // Get user profile from LINE
        async function getUserProfile() {
            try {
                userProfile = await liff.getProfile();
                document.getElementById('userName').textContent = userProfile.displayName;
                document.getElementById('userId').textContent = userProfile.userId;
                
                // Show user avatar
                if (userProfile.pictureUrl) {
                    document.getElementById('userAvatar').innerHTML = `<img src="${userProfile.pictureUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    document.getElementById('userAvatar').textContent = userProfile.displayName.charAt(0);
                }
            } catch (error) {
                console.error('Error getting user profile:', error);
            }
        }
        
        // Load user points from Google Sheets
        async function loadUserPoints() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getPoints&userId=${userProfile.userId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentPoints = data.points || 0;
                    document.getElementById('currentPoints').textContent = currentPoints;
                }
            } catch (error) {
                console.error('Error loading points:', error);
            }
        }
        
        // Load transaction history
        async function loadHistory() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getHistory&userId=${userProfile.userId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayHistory(data.history || []);
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyList').innerHTML = '<div style="text-align: center; color: #666;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</div>';
            }
        }
        
        // Display history
        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</div>';
                return;
            }
            
            historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-details">
                        <div class="history-type ${item.type}">${item.type === 'add' ? '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°' : 'üéÅ ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°'}</div>
                        <div class="history-date">${formatDate(item.date)}</div>
                        <div style="margin-top: 5px; color: #666;">${item.reason}</div>
                    </div>
                    <div class="history-points ${item.type}">
                        ${item.type === 'add' ? '+' : '-'}${item.points}
                    </div>
                </div>
            `).join('');
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Show add points form
        function showAddPoints() {
            document.getElementById('addPointsForm').classList.remove('hidden');
            document.getElementById('redeemPointsForm').classList.add('hidden');
        }
        
        // Hide add points form
        function hideAddPoints() {
            document.getElementById('addPointsForm').classList.add('hidden');
            document.getElementById('addAmount').value = '';
            document.getElementById('addReason').value = '';
        }
        
        // Show redeem points form
        function showRedeemPoints() {
            document.getElementById('redeemPointsForm').classList.remove('hidden');
            document.getElementById('addPointsForm').classList.add('hidden');
        }
        
        // Hide redeem points form
        function hideRedeemPoints() {
            document.getElementById('redeemPointsForm').classList.add('hidden');
            document.getElementById('redeemAmount').value = '';
            document.getElementById('redeemReason').value = '';
        }
        
        // Add points
        async function addPoints() {
            const amount = parseInt(document.getElementById('addAmount').value);
            const reason = document.getElementById('addReason').value;
            
            if (!amount || amount <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!reason.trim()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addPoints',
                        userId: userProfile.userId,
                        userName: userProfile.displayName,
                        amount: amount,
                        reason: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üéâ');
                    await loadUserPoints();
                    await loadHistory();
                    hideAddPoints();
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding points:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°');
            }
        }
        
        // Redeem points
        async function redeemPoints() {
            const amount = parseInt(document.getElementById('redeemAmount').value);
            const reason = document.getElementById('redeemReason').value;
            
            if (!amount || amount <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!reason.trim()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å');
                return;
            }
            
            if (amount > currentPoints) {
                alert('‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠! ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÅ‡∏ï‡πâ‡∏° ' + currentPoints + ' ‡πÅ‡∏ï‡πâ‡∏°');
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'redeemPoints',
                        userId: userProfile.userId,
                        userName: userProfile.displayName,
                        amount: amount,
                        reason: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üéÅ');
                    await loadUserPoints();
                    await loadHistory();
                    hideRedeemPoints();
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
                }
            } catch (error) {
                console.error('Error redeeming points:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°');
            }
        }
        
        // Demo data for testing
        function loadDemoData() {
            document.getElementById('userName').textContent = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
            document.getElementById('userId').textContent = 'demo-user-123';
            document.getElementById('currentPoints').textContent = '150';
            currentPoints = 150;
            
            const demoHistory = [
                { type: 'add', points: 50, reason: '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 500 ‡∏ö‡∏≤‡∏ó', date: '2024-01-15T10:30:00' },
                { type: 'add', points: 100, reason: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©', date: '2024-01-14T14:15:00' },
                { type: 'redeem', points: 30, reason: '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 10%', date: '2024-01-13T16:45:00' }
            ];
            
            displayHistory(demoHistory);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeLiff);
    </script>
</body>
</html>
